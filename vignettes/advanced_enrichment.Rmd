---
title: "Advanced enrichment with osmenrich"
author: "SoDa Team and @vankesteren"
output: rmarkdown::html_vignette
description: >
  A tutorial to use osmenrich in a complex project.
vignette: >
  %\VignetteIndexEntry{advanced_enrichment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Introduction

In this advanced example, you will go through the steps of an example project to enrich data relative to the position of features (shops and natural features) within the city of Utrecht to predict the nesting behavior of sparrows.

### Load libraries

You need to install and load the following libraries to be able to run this example.

Libraries for data wrangling and enrichment:

```{r}
# Data
library(tidyverse)
library(sf)
library(osmenrich)
```

Libraries for modeling:

```{r}
# Modeling
library(mgcv)
```

Libraries for plotting:

```{r}
# Plotting
library(ggspatial)
library(firatheme) # remotes::install_github("vankesteren/firatheme")
library(ggeffects)
```

If you already followed the introductory tutorial, you will know that the `osmenrich` package offers the possibility of creating local instances of both the Overpass API, to serve an instance of OpenStreetMap (OSM) and of OSRM servers, to calculate the routing information.

If you already set up one of these options, you can set the connection variables running the following snippet (remember to change the port of the server(s) to your chosen one!):

```{r}
# Optional: use local version of osm
#osmdata::set_overpass_url("http://localhost:8888/api/interpreter")
#options("osrm.server" = "http://localhost:8080")
```

### Data: sparrows

To demonstrate the usage of `osmenrich`, in this example we will use the dataset of sparrows provided openly by the municipality of Utrecht (The Netherlands).
  
```{r}
data_url <- "https://ckan.dataplatform.nl/dataset/8ceaae10-fb90-4ec0-961c-ef02691bb861/resource/baae4cde-cf33-416b-aa4e-d0fba160eed9/download/gierzwaluwinventarisatie2014.csv"
```

Once you downloaded the dataset, select only the relevant columns using the tidyverse syntax. In this example we are interested in retrieving the `latitude` and `longitude` for each sparrow nest, and the number of nests (`nestcount`). We then convert the latitude and longitude coordinates to a spatial format using the `st_as_sf` from the `sf` package.

```{r, message=FALSE}
bird_sf <-
  read_csv(data_url) %>%
  drop_na(latitude, longitude, `aantal nesten`) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  select(nestcount = "aantal nesten", geometry)
```


To see how the sparrow data look like, you can plot the retrieved points using `ggplot`. The additional parameters are used to create a nice-looking plot but are not necessary for the creation of the map.

```{r, message=FALSE}
# Plot data
plot_bird <-
  ggplot(bird_sf, aes(colour = nestcount, size = nestcount)) +
  annotation_map_tile(zoomin = 0) +
  geom_sf() +
  theme_fira() +
  scale_colour_viridis_c() +
  scale_size(range = c(1, 3), guide = FALSE) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Common swift nests", colour = "")

plot_bird
```

### Data agumentation

Once we know how the data look like, we can proceed with the data augmentation. We need to make some assumptions about the position of the birds, in order to have a working model later on. Therefore, you can assume that the common swift inventarisation is comprehensive over the grid. Therefore, we will randomly sample the data over 200 non-bird sites

Centroids of grid cells where nests were not found

```{r, message=FALSE}
set.seed(45)
bird_grid  <- st_make_grid(bird_sf, n = c(40, 60))
has_nests  <- apply(st_contains(bird_grid, bird_sf, sparse = FALSE), 1, any)
zerosample <- st_centroid(sample(bird_grid[!has_nests], 200))
nonbird_sf <- st_sf(geometry = zerosample) %>% mutate(nestcount = 0)
bird_sf    <- bind_rows(bird_sf, nonbird_sf)
```

We plot augmented data:

```{r}
plot_bird +
  geom_sf(data = nonbird_sf, colour = "black", bg = "black", size = 1, shape = 22)
```



### Data enrichment

#### Use `osmenrich` for computing the data enrichment

We use the the number of trees as a proxy of natural material availability and the number of shops as a proxy of commercial activity. To retrieve these OSM features, you will use the main function from `osmenrich`: `enrich_osm`.

```{r}
bird_sf <-
  bird_sf %>%
  enrich_osm(
    name = "commercial_activity_1km",
    key = "shop",
    kernel = "gaussian",
    r = 1000
  ) %>%
  enrich_osm(
    name = "tree_1km",
    key = "natural",
    value = "tree",
    kernel = "gaussian",
    r = 1000
  )
```
 
We can do the same for a grid covering the bounding box of the data

```{r}
grid_sf_c <-
  st_centroid(bird_grid) %>%
  st_sf() %>%
  enrich_osm(
    name = "commercial_activity_1km",
    key = "shop",
    kernel = "gaussian",
    r = 1000,
    .verbose = TRUE
  ) %>%
  enrich_osm(
    name = "tree_1km",
    key = "natural",
    value = "tree",
    kernel = "gaussian",
    r = 1000,
    .verbose = TRUE
  )
```

And add the geometry to the grid

```{r}
grid_sf_p <- grid_sf_c %>% st_set_geometry(bird_grid)
```


#### Plot predictors on the grid

```{r}
plot_commercial_activity <-
  ggplot() +
  annotation_map_tile(zoomin = 0) +
  geom_sf(data = grid_sf_p, aes(fill = commercial_activity_1km), colour = NA, alpha = 0.7) +
  geom_sf(data = bird_sf %>% filter(nestcount > 0), colour = "black") +
  theme_fira() +
  scale_fill_viridis_c() +
  labs(title = "Commercial activity", fill = "") +
  theme(axis.text.x = element_text(angle = 90))

plot_commercial_activity
```


```{r}
plot_trees <-
  ggplot() +
  annotation_map_tile(zoomin = 0) +
  geom_sf(data = grid_sf_p, aes(fill = tree_1km), colour = NA, alpha = 0.7) +
  geom_sf(data = bird_sf %>% filter(nestcount > 0), colour = "black") +
  theme_fira() +
  scale_fill_viridis_c() +
  labs(title = "Trees", fill = "") +
  theme(axis.text.x = element_text(angle = 90))

plot_trees
```

### Modeling

To model the data we will use a zero-inflated poisson spatial generalized additive model. First, we need a function to turn sf with coordinates into df with x and y

```{r}
sf_to_df <- function(sf) {
  bind_cols(
    as_tibble(sf) %>% select(-geometry),
    st_coordinates(sf) %>% as_tibble() %>% set_names(c("x", "y"))
  )
}
```


Then we define a generalized additive model with mgcv
```{r}
fit <- gam(
  nestcount ~
    te(x, y, bs = "ts") +              # bivariate regularized thin plate spline
    poly(commercial_activity_1km, 2) + # quadratic effect of commercial activity
    tree_1km,                          # natural material availability proxy
  family = "ziP",                      # zero-inflated poisson
  data = sf_to_df(bird_sf)
)
```


### Interpretation and prediction

To see the effects of spline, commercial activity, and natural material availability, simply call:

```{r}
summary(fit)
```

You can also plot the marginal effect of commercial activity

```{r}
values <- seq(0, 0.10, 0.01)
plot_marginal <-
  ggpredict(fit, terms = "commercial_activity_1km [values]",
            condition = c(x = 5.10, y = 52.125)) %>%
  ggplot(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high)) +
  geom_ribbon(alpha = 0.4, fill = firaCols[3]) +
  geom_line(colour = firaCols[3], size = 1) +
  theme_fira() +
  labs(y = "Predicted nests", x = "Commercial activity",
       title = "Marginal effect of commercial activity")

plot_marginal
```

And finally create predictions over previously defined grid

```{r}
pred <- predict(fit, newdata = sf_to_df(grid_sf_c), type = "response", se = TRUE)
```

Plot the predictions over the grid

```{r}
grid_sf_p$pred <- pred$fit
grid_sf_p$se   <- pred$se.fit

plot_pred <-
  ggplot() +
  annotation_map_tile(zoomin = 0) +
  geom_sf(data = grid_sf_p, aes(fill = pred), colour = NA, alpha = 0.7) +
  geom_sf(data = bird_sf %>% filter(nestcount > 0), colour = "black") +
  theme_fira() +
  scale_fill_viridis_c() +
  labs(title = "Nest count", fill = "") +
  theme(axis.text.x = element_text(angle = 90))

plot_pred
```

Plot the spline only

```{r}
grid_sf_c2 <-
  grid_sf_c %>%
  mutate(
    commercial_activity_1km = 0,
    grass_300m = 0,
    tree_300m = 0
  )

pred2 <- predict(fit, newdata = sf_to_df(grid_sf_c2), type = "response", se = TRUE)
grid_sf_p$pred2 <- pred2$fit

plot_pred_smooth_only <-
  ggplot() +
  annotation_map_tile(zoomin = 0) +
  geom_sf(data = grid_sf_p, aes(fill = pred2), colour = NA, alpha = 0.7) +
  geom_sf(data = bird_sf %>% filter(nestcount > 0), colour = "black") +
  theme_fira() +
  scale_fill_viridis_c() +
  labs(title = "Spline-only predictions", fill = "") +
  theme(axis.text.x = element_text(angle = 90))

plot_pred_smooth_only
```
